<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>CSç«‹ä½“å›³ï¼‹åœŸç ‚ç½å®³è­¦æˆ’åŒºåŸŸï¼‹å¤§å­—å¢ƒç•Œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .legend {
      background: #fff;
      padding: 6px 10px;
      line-height: 18px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
    .legend i {
      display: inline-block;
      width: 18px;
      height: 18px;
      margin-right: 8px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.js"></script>

  <script>
    // 1. åœ°å›³ç”Ÿæˆ
    const map = L.map('map').setView([37.3, 136.9], 11);

    // 2. ãƒ™ãƒ¼ã‚¹ãƒ¬ã‚¤ãƒ¤
    const notoCS = L.tileLayer(
      'https://rinya.geospatial.jp/tile/csmaptile_noto/{z}/{x}/{y}.png',
      { maxZoom: 18, attribution: 'Â© <a href="https://rinya.maff.go.jp/">æ—é‡åº</a> (csmaptile_noto)' }
    ).addTo(map);

    const gsiPale = L.tileLayer(
      'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png',
      { maxZoom: 18, opacity: 0.6, attribution: 'Â© <a href="https://www.gsi.go.jp/">å›½åœŸåœ°ç†é™¢</a>' }
    );

    // 3. ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
    const baseLayers = { 'Noto CSMap': notoCS };
    const overlays   = { 'æ·¡è‰²åœ°å›³': gsiPale };
    const ctl = L.control.layers(baseLayers, overlays, { collapsed:false }).addTo(map);
    L.control.scale({ position:'bottomleft', imperial:false }).addTo(map);

    // 4. åœŸç ‚ç½å®³è­¦æˆ’åŒºåŸŸ
    fetch('https://raw.githubusercontent.com/eronex1181/noto-map/main/dosya.geojson')
      .then(r => r.json())
      .then(data => {
        const zoneColor = v => (v == 1 || v === '1') ? '#ffff00'
                            : (v == 2 || v === '2') ? '#ff0000'
                            : '#888888';
        const zoneName = v => (v == 1 || v === '1') ? 'ã‚¤ã‚¨ãƒ­ãƒ¼ã‚¾ãƒ¼ãƒ³'
                           : (v == 2 || v === '2') ? 'ãƒ¬ãƒƒãƒ‰ã‚¾ãƒ¼ãƒ³'
                           : 'ãã®ä»–';

        const geoLayer = L.geoJSON(data, {
          style: f => ({
            color : zoneColor(f.properties.A33_002),
            weight: 2,
            opacity: 0.9
          }),
          pointToLayer: (f, latlng) => L.circleMarker(latlng, {
            radius: 5,
            fillColor: zoneColor(f.properties.A33_002),
            color: '#ffffff',
            weight: 1,
            fillOpacity: 0.8
          }),
          onEachFeature: (f, layer) => {
            const p = f.properties ?? {};
            layer.bindPopup(
              `<b>${zoneName(p.A33_002)}</b><br>` +
              `<b>ç®‡æ‰€ç•ªå·:</b> ${p.A33_004 ?? '-'}<br>` +
              `<b>ç®‡æ‰€å:</b> ${p.A33_005 ?? '-'}`
            );
          }
        }).addTo(map);
        ctl.addOverlay(geoLayer, 'åœŸç ‚ç½å®³è­¦æˆ’åŒºåŸŸ');

        // æ¤œç´¢ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆç®‡æ‰€ç•ªå·ï¼‰
        new L.Control.Search({
          layer: geoLayer,
          propertyName: 'A33_004',
          textPlaceholder: 'ç®‡æ‰€ç•ªå·ã‚’å…¥åŠ›',
          zoom: 15,
          marker: false,
          moveToLocation: (latlng, z) => map.setView(latlng, z)
        }).addTo(map);

        // å‡¡ä¾‹
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = () => {
          const d = L.DomUtil.create('div', 'legend');
          d.innerHTML =
            '<i style="background:#ffff00"></i> ã‚¤ã‚¨ãƒ­ãƒ¼ã‚¾ãƒ¼ãƒ³<br>' +
            '<i style="background:#ff0000"></i> ãƒ¬ãƒƒãƒ‰ã‚¾ãƒ¼ãƒ³<br>' +
            '<i style="background:transparent;border:2px dashed green"></i> å¤§å­—å¢ƒç•Œ';
          return d;
        };
        legend.addTo(map);
      });

    // 5. å¤§å­—å¢ƒç•Œãƒ¬ã‚¤ãƒ¤
    fetch('https://raw.githubusercontent.com/eronex1181/noto-map/main/kyoukai.geojson')
      .then(r => r.json())
      .then(data => {
        const kyoLayer = L.geoJSON(data, {
          style: {
            color: 'green',
            weight: 2,
            dashArray: '5,5',
            opacity: 1
          },
          onEachFeature: (f, layer) => {
            const name = f.properties?.å¤§å­— ?? 'åç§°ä¸æ˜';
            layer.bindPopup(`<b>å¤§å­—:</b> ${name}`);
          }
        }).addTo(map);
        ctl.addOverlay(kyoLayer, 'å¤§å­—å¢ƒç•Œ');
      });

    // 6. ç¾åœ¨åœ°è¡¨ç¤º
    map.locate({ setView: false });

    const locationBtn = L.control({ position: 'topleft' });
    locationBtn.onAdd = () => {
      const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
      div.innerHTML = '<a href="#" title="ç¾åœ¨åœ°ã‚’è¡¨ç¤º" style="font-size:18px;">ğŸ“</a>';
      div.style.cursor = 'pointer';
      div.onclick = e => {
        e.preventDefault();
        map.locate({ setView: true, maxZoom: 16 });
      };
      return div;
    };
    locationBtn.addTo(map);

    map.on('locationfound', e => {
      L.circleMarker(e.latlng, {
        radius: 7,
        fillColor: '#3388ff',
        color: '#ffffff',
        weight: 2,
        fillOpacity: 0.9
      }).addTo(map)
        .bindPopup('ç¾åœ¨åœ°').openPopup();
    });

    map.on('locationerror', () => {
      alert('ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä½ç½®æƒ…å ±ã®åˆ©ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
    });
  </script>
</body>
</html>
