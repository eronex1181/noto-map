<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Noto CSMap＋土砂災害警戒区域＋大字境界</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- Leaflet -------------------------------------------------------------->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Leaflet-Search ------------------------------------------------------->
<link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.css">
<script src="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.js"></script>

<style>
html,body,#map{height:100%;margin:0}
.leaflet-control-attribution{font-size:11px}
/* 凡例 */
.legend{
  background:#fff;padding:6px 10px;line-height:18px;
  box-shadow:0 0 15px rgba(0,0,0,.2)
}
.legend i{
  display:inline-block;width:18px;height:18px;margin-right:8px
}
/* 緑破線シンボル（大字境界） */
.legend-line{
  display:inline-block;width:18px;height:0;
  border-top:3px dashed #008000;margin-right:8px;
  vertical-align:middle
}
</style>
</head>
<body>
<div id="map"></div>

<script>
// ──────────────────────────────
// 1. 地図生成
// ──────────────────────────────
const map=L.map('map').setView([37.3,136.9],11);

// 2. ベースレイヤ
const notoCS=L.tileLayer(
  'https://rinya.geospatial.jp/tile/csmaptile_noto/{z}/{x}/{y}.png',
  {maxZoom:18,attribution:'© <a href="https://rinya.maff.go.jp/">林野庁</a> (csmaptile_noto)'}
).addTo(map);

// 3. オーバーレイ（淡色地図）
const gsiPale=L.tileLayer(
  'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png',
  {maxZoom:18,opacity:.6,attribution:'© <a href="https://www.gsi.go.jp/">国土地理院</a>'}
);

// 4. レイヤーコントロール
const ctl=L.control.layers(
  {'Noto CSMap':notoCS},          // base
  {'淡色地図':gsiPale},           // overlay（初期は空、順番保持のため登録）
  {collapsed:false}
).addTo(map);
L.control.scale({position:'bottomleft',imperial:false}).addTo(map);

// ──────────────────────────────
// 5. 大字境界（先に読み込み＆コントロール登録）
// ──────────────────────────────
fetch('https://rawcdn.githack.com/eronex1181/noto-map/main/kyoukai.geojson')
  .then(r=>r.json()).then(js=>{
    const kyoukai=L.geoJSON(js,{
      style:{color:'#008000',weight:2,opacity:1,dashArray:'6 4'},
      onEachFeature:(f,l)=>{
        const p=f.properties??{};
        const oaza=p.OAZA||p.大字||p.NAME||p.name||'名称未設定';
        l.bindPopup(`<b>大字:</b> ${oaza}`);
      }
    }).addTo(map);
    ctl.addOverlay(kyoukai,'大字境界');          // ★コントロール最上段
  })
  .catch(e=>console.error('kyoukai.geojson 読込失敗',e));

// ──────────────────────────────
// 6. 土砂災害警戒区域
// ──────────────────────────────
fetch('https://rawcdn.githack.com/eronex1181/noto-map/main/dosya.geojson')
  .then(r=>r.json()).then(data=>{
    const zoneColor=v=>(v==1?'#ffff00':v==2?'#ff0000':'#888');
    const zoneName =v=>(v==1?'イエローゾーン':v==2?'レッドゾーン':'その他');

    const geoLayer=L.geoJSON(data,{
      style:f=>({color:zoneColor(f.properties.A33_002),weight:2,opacity:.9}),
      pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
        radius:5,fillColor:zoneColor(f.properties.A33_002),
        color:'#fff',weight:1,fillOpacity:.8}),
      onEachFeature:(f,l)=>{
        const p=f.properties??{};
        l.bindPopup(
          `<b>${zoneName(p.A33_002)}</b><br>`+
          `<b>箇所番号:</b> ${p.A33_004??'-'}<br>`+
          `<b>箇所名:</b> ${p.A33_005??'-'}`
        );
        p._searchkey=`${p.A33_004??''} ${p.A33_005??''}`.trim();
      }
    }).addTo(map);

    ctl.addOverlay(geoLayer,'土砂災害警戒区域'); // ★コントロール下段
    map.fitBounds(geoLayer.getBounds());

    // 検索コントロール
    new L.Control.Search({
      layer:geoLayer,propertyName:'_searchkey',
      textPlaceholder:'箇所番号・箇所名で検索',
      zoom:15,marker:false,
      moveToLocation:(latlng,z)=>map.setView(latlng,z)
    }).addTo(map);
  })
  .catch(e=>console.error('dosya.geojson 読込失敗',e));

// ──────────────────────────────
// 7. 凡例
// ──────────────────────────────
L.control({position:'bottomright'}).onAdd=()=>{
  const d=L.DomUtil.create('div','legend');
  d.innerHTML=
    '<i style="background:#ffff00"></i>イエローゾーン<br>'+
    '<i style="background:#ff0000"></i>レッドゾーン<br>'+
    '<span class="legend-line"></span> 大字境界';
  return d;
}.addTo(map);
</script>
</body>
</html>
